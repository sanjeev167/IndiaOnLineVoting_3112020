/**
 * 
 */
package com.pon.pvt.voting.service;

import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.pon.pvt.master.entity.VotersEnrolled;
import com.pon.pvt.master.repo.AssemblyCandidateRepository;
import com.pon.pvt.master.repo.LoksabhaCandidateRepository;
import com.pon.pvt.master.repo.VotersEnrolledRepository;
import com.pon.pvt.voting.dto.AssemblyBalletForEnrolledVotersDTO;
import com.pon.pvt.voting.dto.ElectionDetailDTO;
import com.pon.pvt.voting.dto.VoteDetailDTO;
import com.pon.pvt.voting.dto.VoterDetailsDTO;
import com.pon.pvt.voting.entity.AssemblyBalletForEnrolledVoters;
import com.pon.pvt.voting.entity.VoteRepository;
import com.pon.pvt.voting.repo.VoteRepositoryRepository;
import com.support.custom.exception.CustomRuntimeException;
import com.support.custom.exception.ExceptionApplicationUtility;
import com.support.grid_pagination.DataTableRequest;
import com.support.grid_pagination.DataTableResults;
import com.support.grid_pagination.PaginationCriteria;
import com.support.util.AgeCalculator;
import com.support.util.AppConstants;
import com.support.util.AppUtil;

/**
 * @author Sanjeev
 *
 */

@Service
public class OfflineBalletServiceImpl implements OfflineBalletService{
	private static final Logger log = LoggerFactory.getLogger(OfflineBalletServiceImpl.class);
	
	
	/** The entity manager. */
	@Autowired
	@PersistenceContext(unitName= AppConstants.JPA_UNIT_LOSTVOTE)
	private EntityManager entityManager;
	
	@Autowired
	VotersEnrolledRepository votersEnrolledRepository;
	
	@Autowired
	LoksabhaCandidateRepository loksabhaCandidateRepository;
	
	@Autowired
	AssemblyCandidateRepository assemblyCandidateRepository;
	
	@Autowired
	VoteRepositoryRepository voteRepositoryRepository;

	@Override
	public DataTableResults<AssemblyBalletForEnrolledVotersDTO> loadElectionBalletPaperGrid(String voterId,  HttpServletRequest request) throws CustomRuntimeException {
		log.info("     OfflineBalletServiceImpl :==> loadElectionBalletPaperGrid :==> Started");
		
		String whereClause="	and ve.voter_id='"+voterId+"' ";
		DataTableResults<AssemblyBalletForEnrolledVotersDTO> dataTableResult;
		try {
			DataTableRequest<AssemblyBalletForEnrolledVoters> dataTableInRQ = new DataTableRequest<AssemblyBalletForEnrolledVoters>(request);
			PaginationCriteria pagination = dataTableInRQ.getPaginationRequest();
			
		String baseQuery="select acm.id as assemblyCandidateId, pbm.name as pollingBoothName,pbm.booth_no as pollingBoothNo,"
									+ "  am.name as assemblyName,"
									+ "  acm.name as assemblyCandidateName,   "
									+ "  pm.name as partyName,"
									+ "  ps.name_with_ext as symbolName,"
									+ "  (SELECT COUNT(1) "
									+ "  from  voters_enrolled ve,"
									+ "  polling_booth_master pbm, "
									+ "  assembly_master am,"
									+ "  assembly_candidate_master acm,"
									+ "  party_master pm,"
									+ "  party_symbol ps   "
									+ "	where "
									+ "	ve.booth_id=pbm.id and"
									+ "	pbm.assembly_id=am.id and"
									+ "	acm.assembly_id=am.id and"
									+ "	acm.party_id=pm.id and"
									+ "	pm.symbol_id=ps.id "									
									+ whereClause									
									+ " ) AS totalrecords "
									
									+ "from  voters_enrolled ve,"
									+ " polling_booth_master pbm, "
									+ " assembly_master am,"
									+ " assembly_candidate_master acm,"
									+ " party_master pm,"
									+ " party_symbol ps   "
									+ "where "
									+ " ve.booth_id=pbm.id and"
									+ " pbm.assembly_id=am.id and"
									+ " acm.assembly_id=am.id and"
									+ " acm.party_id=pm.id and"
									+ " pm.symbol_id=ps.id "									
									+ whereClause;
					
		    //System.out.println("baseQuery = "+baseQuery);
			String paginatedQuery = AppUtil.buildPaginatedQuery(baseQuery, pagination);		
			Query query = entityManager.createNativeQuery(paginatedQuery, "AssemblyBalletForEnrolledVotersDTOMapping");

			@SuppressWarnings("unchecked")
			List<AssemblyBalletForEnrolledVotersDTO> assemblyBalletForEnrolledVotersList = query.getResultList();		

			dataTableResult = new DataTableResults<AssemblyBalletForEnrolledVotersDTO>();
			dataTableResult.setDraw(dataTableInRQ.getDraw());
			dataTableResult.setListOfDataObjects(assemblyBalletForEnrolledVotersList);
			if (!AppUtil.isObjectEmpty(assemblyBalletForEnrolledVotersList)) {
				dataTableResult.setRecordsTotal(assemblyBalletForEnrolledVotersList.get(0).getTotalrecords().toString());
				if (dataTableInRQ.getPaginationRequest().isFilterByEmpty()) {
					dataTableResult.setRecordsFiltered(assemblyBalletForEnrolledVotersList.get(0).getTotalrecords().toString());
				} else {
					dataTableResult.setRecordsFiltered(Integer.toString(assemblyBalletForEnrolledVotersList.size()));
				}
			}
		}catch(Exception ex) {throw ExceptionApplicationUtility.wrapRunTimeException(ex);}
		log.info("     OfflineBalletServiceImpl :==> loadElectionBalletPaperGrid :==> Ended");
		return dataTableResult;
	}

	@Override
	public ElectionDetailDTO loadElectionDetails(String voterId, String electionType) throws CustomRuntimeException {
		// TODO Auto-generated method stub
		ElectionDetailDTO electionDetailDTO=new ElectionDetailDTO();		
		VotersEnrolled votersEnrolled= votersEnrolledRepository.findByVoterId(voterId);
		
		electionDetailDTO.setElectionType(electionType);
		electionDetailDTO.setStateName(votersEnrolled.getBoothId().getAssemblyId().getLoksabhaId().getStateId().getName());
		electionDetailDTO.setLoksabhaNameId(votersEnrolled.getBoothId().getAssemblyId().getLoksabhaId().getId()+"");		
		electionDetailDTO.setAssemblyNameId(votersEnrolled.getBoothId().getAssemblyId().getId()+"");
		electionDetailDTO.setPollingBoothNameId(votersEnrolled.getBoothId()+"");
		
		electionDetailDTO.setLoksabhaName(votersEnrolled.getBoothId().getAssemblyId().getLoksabhaId().getName());		
		electionDetailDTO.setAssemblyName(votersEnrolled.getBoothId().getAssemblyId().getName());
		electionDetailDTO.setPollingBoothName(votersEnrolled.getBoothId().getName());
		
		
		electionDetailDTO.setElectionYear("2020");		
		return electionDetailDTO;
	}

	@Override
	public VoterDetailsDTO loadVotersDetails(String voterId) throws CustomRuntimeException {
		// TODO Auto-generated method stub
		VoterDetailsDTO voterDetailsDTO=new VoterDetailsDTO();
		VotersEnrolled votersEnrolled= votersEnrolledRepository.findByVoterId(voterId);
		voterDetailsDTO.setName(votersEnrolled.getName());
		
		voterDetailsDTO.setAge(AgeCalculator.calculateAge(votersEnrolled.getDob()).getYears()+"");
		
		voterDetailsDTO.setVoterId(votersEnrolled.getVoterId());
		
		voterDetailsDTO.setDob(AppUtil.convertJavaDateIntoStringDate(votersEnrolled.getDob()));
		voterDetailsDTO.setSex(votersEnrolled.getSex());
		
		voterDetailsDTO.setFatherName(votersEnrolled.getFatherName());
		voterDetailsDTO.setAddress(votersEnrolled.getAddress());
		return voterDetailsDTO;
	}

	@Override
	public boolean castVote(@Valid VoteDetailDTO voteDetailDTO) throws CustomRuntimeException {
		// TODO Auto-generated method stub
		VoteRepository voteRepositoryInsert=new VoteRepository();
		VoteRepository voteRepository=voteRepositoryRepository.saveAndFlush(entity);
		
		return false;
	}

	
	

}
